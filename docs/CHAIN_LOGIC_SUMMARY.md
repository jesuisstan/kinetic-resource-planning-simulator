# Логика построения цепочки выполнения процессов в KRPSIM

## Обзор системы

KRPSIM (Kinetic Resource Planning Simulator) - это система планирования ресурсов, которая использует генетический алгоритм для поиска оптимальной последовательности выполнения процессов для достижения заданных целей.

## Основные компоненты

### 1. Структуры данных

- **Stock** - ресурсы с количеством
- **Process** - процессы с входами, выходами и длительностью
- **Config** - конфигурация с процессами, ресурсами и целями оптимизации
- **Individual** - особь генетического алгоритма (последовательность процессов)

### 2. Ключевые функции

#### Проверка возможности выполнения процесса

```typescript
canStartProcess(process, stocks, config);
```

- Проверяет наличие всех необходимых ресурсов
- Учитывает критические ресурсы (используемые всеми процессами)
- Предотвращает истощение критических ресурсов

#### Обновление ресурсов после процесса

```typescript
updateStocksAfterProcess(process, stocks, config);
```

- Удаляет потребленные ресурсы
- Добавляет произведенные ресурсы
- Обеспечивает защиту критических ресурсов

#### Симуляция выполнения

```typescript
runSimulation(config, processSequence, timeLimit);
```

- Выполняет последовательность процессов
- Отслеживает время и ресурсы
- Вычисляет фитнес-оценку

## Логика генетического алгоритма

### 1. Создание умных особей

Система использует несколько стратегий для создания начальных особей:

#### Стратегия 1: Фокус на высокоприоритетных процессах

- Выбирает процессы с наивысшим приоритетом
- Учитывает сохранение критических ресурсов
- Предпочитает процессы, не истощающие критические ресурсы

#### Стратегия 2: Исследование различных типов процессов

- Чередует разные типы процессов
- Обеспечивает разнообразие в популяции
- Управляет ресурсами между типами процессов

#### Стратегия 3: Случайное исследование с приоритетом

- Комбинирует случайность с приоритетами
- Сохраняет критические ресурсы
- Обеспечивает исследование пространства решений

### 2. Расчет приоритетов процессов

```typescript
buildProcessPriority(processes, optimizeGoals);
```

1. **Построение графа зависимостей ресурсов**

   - Определяет производителей и потребителей каждого ресурса
   - Создает карту связей между ресурсами

2. **Вычисление расстояний до целей**

   - Использует BFS для нахождения кратчайшего пути к целям
   - Присваивает приоритеты на основе расстояния

3. **Приоритизация процессов**
   - Процессы, производящие цели напрямую: приоритет 0
   - Остальные процессы: приоритет = минимальное расстояние до цели

### 3. Эволюция популяции

#### Отбор

- Элитизм: лучшие особи сохраняются
- Турнирный отбор для остальных особей

#### Скрещивание

- Одноточечное скрещивание
- Настраиваемая вероятность скрещивания

#### Мутация

- Случайные изменения в последовательности
- Настраиваемая вероятность мутации

## Примеры выполнения

### Простой пример (simple)

```
Цели: time, client_content
Ресурсы: euro:10
Процессы:
- achat_materiel: euro:8 → materiel:1 (10 циклов)
- realisation_produit: materiel:1 → produit:1 (30 циклов)
- livraison: produit:1 → client_content:1 (20 циклов)

Оптимальная последовательность:
0:achat_materiel (euro:10→2, materiel:0→1)
10:realisation_produit (materiel:1→0, produit:0→1)
40:livraison (produit:1→0, client_content:0→1)

Результат: client_content: 1, время: 60 циклов
```

### Сложный пример (ikea)

```
Цели: time, armoire
Ресурсы: planche:7
Процессы:
- do_montant: planche:1 → montant:1 (15 циклов)
- do_fond: planche:2 → fond:1 (20 циклов)
- do_etagere: planche:1 → etagere:1 (10 циклов)
- do_armoire_ikea: montant:2, fond:1, etagere:3 → armoire:1 (30 циклов)

Оптимальная последовательность:
0:do_montant (planche:7→6, montant:0→1)
15:do_etagere (planche:6→5, etagere:0→1)
25:do_etagere (planche:5→4, etagere:1→2)
35:do_etagere (planche:4→3, etagere:2→3)
45:do_fond (planche:3→1, fond:0→1)
65:do_montant (planche:1→0, montant:1→2)
80:do_armoire_ikea (montant:2→0, fond:1→0, etagere:3→0, armoire:0→1)

Результат: armoire: 1, время: 110 циклов
```

## Ключевые особенности

### 1. Управление критическими ресурсами

- Система идентифицирует ресурсы, используемые всеми процессами
- Предотвращает их истощение
- Обеспечивает устойчивость системы

### 2. Адаптивные параметры

- Параметры генетического алгоритма настраиваются на основе сложности задачи
- Количество поколений и размер популяции зависят от количества процессов и ресурсов

### 3. Множественные стратегии

- Различные подходы к созданию особей обеспечивают разнообразие
- Комбинирование стратегий улучшает качество решений

### 4. Эффективная оценка фитнеса

- Учитывает достижение целей
- Штрафует за неэффективное использование времени
- Поощряет выполнение процессов

## Использование отладочных скриптов

### Базовый анализ

```bash
npm run debug -- resources/simple 1000
```

### Оптимальный анализ с генетическим алгоритмом

```bash
npm run debug-optimal -- resources/simple 1000
```

Эти скрипты показывают:

- Анализ зависимостей процессов
- Пошаговое выполнение последовательности
- Детальную информацию о ресурсах
- Анализ эффективности решения
