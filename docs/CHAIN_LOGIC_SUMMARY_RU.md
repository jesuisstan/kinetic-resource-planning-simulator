# Логика построения цепочки выполнения процессов в KRPSIM

## Обзор системы

KRPSIM (Kinetic Resource Planning Simulator) - это система планирования ресурсов, которая использует генетический алгоритм для поиска оптимальной последовательности выполнения процессов для достижения заданных целей.

## Основные компоненты

### 1. Структуры данных

- **Stock** - ресурсы с количеством
- **Process** - процессы с входами, выходами и длительностью
- **Config** - конфигурация с процессами, ресурсами и целями оптимизации
- **Individual** - особь генетического алгоритма (последовательность процессов)

### 2. Ключевые функции

#### Проверка возможности выполнения процесса

```typescript
canStartProcess(process, stocks, config);
```

- Проверяет наличие всех необходимых ресурсов
- Учитывает критические ресурсы (используемые всеми процессами)
- Предотвращает истощение критических ресурсов

#### Обновление ресурсов после процесса

```typescript
updateStocksAfterProcess(process, stocks, config);
```

- Удаляет потребленные ресурсы
- Добавляет произведенные ресурсы
- Обеспечивает защиту критических ресурсов

#### Симуляция выполнения

```typescript
runSimulation(config, processSequence, timeLimit);
```

- Выполняет последовательность процессов
- Отслеживает время и ресурсы
- Вычисляет фитнес-оценку с бонусами за накопление ресурсов

## Логика генетического алгоритма

### 1. Создание умных особей

Система использует четыре стратегии для создания начальных особей:

#### Стратегия 1: Фокус на высокоприоритетных процессах (25% случаев)

- Выбирает процессы с наивысшим приоритетом
- Учитывает сохранение критических ресурсов
- Предпочитает процессы, не истощающие критические ресурсы

#### Стратегия 2: Исследование различных типов процессов (25% случаев)

- Чередует разные типы процессов (по префиксу имени)
- Обеспечивает разнообразие в популяции
- Управляет ресурсами между типами процессов

#### Стратегия 3: Случайное исследование с приоритетом (25% случаев)

- Комбинирует случайность с приоритетами
- Сохраняет критические ресурсы
- Обеспечивает исследование пространства решений

#### Стратегия 4: Иерархическое планирование (25% случаев)

- **Фаза 1:** Процессы с очень высокой ценностью (>10000 единиц цели)
- **Фаза 2:** Прямые производители входов для процессов Фазы 1
- **Фаза 3:** Производители входов для процессов Фазы 2
- Планирует накопление ресурсов для завершения цепочек
- Блокирует продажу промежуточных продуктов до готовности цепочек

### 2. Расчет приоритетов процессов

```typescript
buildProcessPriority(processes, optimizeGoals);
```

1. **Построение графа зависимостей ресурсов**

   - Определяет производителей и потребителей каждого ресурса
   - Создает карту связей между ресурсами

2. **Вычисление экономической ценности процессов**

   - Рассчитывает прибыльность каждого процесса
   - Учитывает стоимость входов и ценность выходов
   - Применяет бонусы/штрафы на основе экономической ценности

3. **Приоритизация процессов**
   - Процессы, производящие цели напрямую: высокий приоритет
   - Процессы с высокой прибыльностью: повышенный приоритет
   - Остальные процессы: приоритет на основе экономической ценности

### 3. Планирование резервов ресурсов

```typescript
planReserveTargets(processes, goals, maxDepth);
```

- Вычисляет целевые количества ресурсов для высокоценных цепочек
- Определяет количество запусков для достижения целей
- Учитывает сложность процессов и масштаб производства

### 4. Выбор лучшего производителя

```typescript
chooseBestProducer(producers, resource);
```

- Оценивает производителей по выходу за цикл
- Учитывает экономическую ценность выходов
- Применяет штраф за сложность (много входов)

### 5. Эволюция популяции

#### Отбор

- Элитизм: лучшие особи сохраняются
- Турнирный отбор для остальных особей

#### Скрещивание

- Одноточечное скрещивание
- Настраиваемая вероятность скрещивания (75-95%)

#### Мутация

- Случайные изменения в последовательности
- Настраиваемая вероятность мутации (8-20%)

## Улучшения фитнес-функции

### Бонусы за накопление ресурсов

```typescript
// Бонус за накопление ресурсов для высокоценных цепочек
chainAccumulationBonus += (currentQuantity / targetQuantity) * 0.5;

// Бонус за производство промежуточных продуктов
intermediateProductionBonus += outputValue / 1000;
```

### Штрафы за неэффективность

- Штраф за неиспользованное время
- Штраф за истощение критических ресурсов
- Штраф за невыполнение процессов

## Примеры выполнения

### Простой пример (simple)

```
Цели: time, client_content
Ресурсы: euro:10
Процессы:
- achat_materiel: euro:8 → materiel:1 (10 циклов)
- realisation_produit: materiel:1 → produit:1 (30 циклов)
- livraison: produit:1 → client_content:1 (20 циклов)

Оптимальная последовательность:
0:achat_materiel (euro:10→2, materiel:0→1)
10:realisation_produit (materiel:1→0, produit:0→1)
40:livraison (produit:1→0, client_content:0→1)

Результат: client_content: 1, время: 60 циклов
```

### Сложный пример (ikea)

```
Цели: time, armoire
Ресурсы: planche:7
Процессы:
- do_montant: planche:1 → montant:1 (15 циклов)
- do_fond: planche:2 → fond:1 (20 циклов)
- do_etagere: planche:1 → etagere:1 (10 циклов)
- do_armoire_ikea: montant:2, fond:1, etagere:3 → armoire:1 (30 циклов)

Оптимальная последовательность:
0:do_montant (planche:7→6, montant:0→1)
15:do_etagere (planche:6→5, etagere:0→1)
25:do_etagere (planche:5→4, etagere:1→2)
35:do_etagere (planche:4→3, etagere:2→3)
45:do_fond (planche:3→1, fond:0→1)
65:do_montant (planche:1→0, montant:1→2)
80:do_armoire_ikea (montant:2→0, fond:1→0, etagere:3→0, armoire:0→1)

Результат: armoire: 1, время: 110 циклов
```

### Сложный пример (pomme)

```
Цели: euro
Ресурсы: four:10, euro:10000
Процессы:
- buy_pomme: euro:100 → pomme:700 (200 циклов)
- buy_citron: euro:100 → citron:400 (200 циклов)
- buy_oeuf: euro:100 → oeuf:100 (200 циклов)
- separation_oeuf: oeuf:1 → jaune_oeuf:1, blanc_oeuf:1 (2 цикла)
- do_tarte_pomme: pomme:1, pate_sablee:1 → tarte_pomme:1 (30 циклов)
- do_tarte_citron: citron:1, pate_sablee:1 → tarte_citron:1 (30 циклов)
- do_flan: lait:1, oeuf:1 → flan:1 (20 циклов)
- do_boite: tarte_citron:3, tarte_pomme:7, flan:1, euro:30 → boite:1 (50 циклов)
- vente_boite: boite:100 → euro:55000 (30 циклов)

Иерархическое планирование:
- Фаза 1: vente_boite (цель: 55000 euro)
- Фаза 2: do_boite (требует tarte_citron, tarte_pomme, flan)
- Фаза 3: do_tarte_citron, do_tarte_pomme, do_flan (требуют базовые ресурсы)

Результат: Накопление промежуточных продуктов для производства boite
```

## Ключевые особенности

### 1. Управление критическими ресурсами

- Система идентифицирует ресурсы, используемые многими процессами
- Предотвращает их истощение
- Обеспечивает устойчивость системы

### 2. Иерархическое планирование

- Планирует высокоуровневые цели сначала
- Детализирует подпроцессы и накопление ресурсов
- Блокирует продажу до завершения цепочек

### 3. Экономическая оптимизация

- Рассчитывает прибыльность процессов
- Приоритизирует высокодоходные процессы
- Учитывает цепочки создания стоимости

### 4. Адаптивные параметры

- Параметры генетического алгоритма настраиваются на основе сложности задачи
- Количество поколений и размер популяции зависят от количества процессов и ресурсов

### 5. Множественные стратегии

- Различные подходы к созданию особей обеспечивают разнообразие
- Комбинирование стратегий улучшает качество решений

### 6. Улучшенная оценка фитнеса

- Учитывает достижение целей
- Бонусы за накопление ресурсов для высокоценных цепочек
- Бонусы за производство промежуточных продуктов
- Штрафует за неэффективное использование времени

## Использование отладочных скриптов

### Экономический анализ

```bash
npm run debug-economic -- resources/pomme
```

Показывает:

- Экономическую ценность каждого процесса
- Прибыльность и маржу
- Анализ цепочек ресурсов
- Рекомендации по приоритизации

### Оптимальный анализ с генетическим алгоритмом

```bash
npm run debug-optimal -- resources/simple 1000
```

Показывает:

- Анализ зависимостей процессов
- Пошаговое выполнение последовательности
- Детальную информацию о ресурсах
- Анализ эффективности решения

### Основной симулятор

```bash
npm run krpsim -- resources/pomme 50000
```

Показывает:

- Красивый вывод с эмодзи
- Детальную информацию о файле и процессах
- Прогресс генетического алгоритма
- Финальные результаты с изменениями ресурсов
- Логи выполнения в отдельные файлы для каждого сценария
